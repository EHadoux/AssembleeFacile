name: Build & Deploy

on: workflow_dispatch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOSSIERS_URL: 'https://data.assemblee-nationale.fr/static/openData/repository/17/loi/dossiers_legislatifs/Dossiers_Legislatifs.json.zip'
  SCRUTINS_URL: 'https://data.assemblee-nationale.fr/static/openData/repository/17/loi/scrutins/Scrutins.json.zip'

jobs:
  update-db:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Download député CSV
        run: npm run db:download-deputes
      - name: Seed députés into database
        run: npm run db:seed-deputes
      - name: Seed articles into database
        run: npm run db:seed-articles
      - name: Download dossiers législatifs
        run: curl -fsSL -o /tmp/Dossiers_Legislatifs.json.zip "$DOSSIERS_URL"
      - name: Normalise article authors from ZIP
        run: npm run db:normalize-authors-zip /tmp/Dossiers_Legislatifs.json.zip
      - name: Normalise article authors
        run: npm run db:clean-authors
      - name: Link dossier refs to articles
        run: npm run db:link-dossiers /tmp/Dossiers_Legislatifs.json.zip
      - name: Download scrutins
        run: curl -fsSL -o /tmp/Scrutins.json.zip "$SCRUTINS_URL"
      - name: Import scrutins
        run: npm run db:import-scrutins /tmp/Dossiers_Legislatifs.json.zip /tmp/Scrutins.json.zip
      - name: Upload DB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-artifacts
          path: |
            db/assemblee.db
            assets/deputes-active.csv

  update-etapes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Download dossiers législatifs
        run: curl -fsSL -o /tmp/Dossiers_Legislatifs.json.zip "$DOSSIERS_URL"
      - name: Update étapes parlementaires
        run: npm run db:update-etapes /tmp/Dossiers_Legislatifs.json.zip
      - name: Collect changed posts
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD -- content/posts/)
          if [ -n "$CHANGED" ]; then
            echo "$CHANGED" | tar czf /tmp/changed-posts.tar.gz -T -
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Upload changed posts
        if: steps.changed.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: etapes-artifacts
          path: /tmp/changed-posts.tar.gz

  commit:
    needs: [update-db, update-etapes]
    # Run as long as the DB job succeeded, even if étapes job failed
    if: ${{ !cancelled() && needs.update-db.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Apply DB artifacts
        uses: actions/download-artifact@v4
        with:
          name: db-artifacts
      - name: Download étapes artifacts
        id: dl-etapes
        uses: actions/download-artifact@v4
        with:
          name: etapes-artifacts
          path: /tmp/etapes
        continue-on-error: true
      - name: Apply étapes changes
        if: steps.dl-etapes.outcome == 'success'
        run: tar xzf /tmp/etapes/changed-posts.tar.gz
      - name: Commit updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/deputes-active.csv db/assemblee.db content/posts/
          git diff --staged --quiet || git commit -m "chore: update député data and article authors [skip ci]"
          git push

  build-site:
    needs: commit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Build site
        run: npm run build
      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: build/

  build-og:
    needs: commit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Restore photo cache
        uses: actions/cache@v4
        with:
          path: assets/og-photo-cache
          key: og-photos-${{ hashFiles('assets/deputes-active.csv') }}
          restore-keys: |
            og-photos-
      - run: npm ci
      - name: Generate OG images (parallel)
        run: |
          npm run build:ogmain    & PID_HOME=$!
          npm run build:ogprop    & PID_POSTS=$!
          npm run build:ogauteurs & PID_AUTEURS=$!
          FAIL=0
          wait $PID_HOME    || FAIL=1
          wait $PID_POSTS   || FAIL=1
          wait $PID_AUTEURS || FAIL=1
          exit $FAIL
      - name: Upload OG images artifact
        uses: actions/upload-artifact@v4
        with:
          name: og-images
          path: static/og/

  deploy:
    needs: [build-site, build-og]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: build/
      - name: Download OG images artifact
        uses: actions/download-artifact@v4
        with:
          name: og-images
          path: build/og/
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          cname: anfacile.fr

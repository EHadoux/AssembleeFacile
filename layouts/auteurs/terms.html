{{- define "main" }} 
{{- if .Title }}
<header class="page-header">
  <h1>{{ .Title }}</h1>
  {{- if .Description }}
  <div class="post-description">{{ .Description }}</div>
  {{- end }}
</header>
{{- end }} 

{{/* Load and parse CSV data using new Hugo syntax */}}
{{ $csvResource := resources.Get "deputes-active.csv" }}
{{ $csvData := $csvResource | transform.Unmarshal (dict "delimiter" ",") }}

{{/* Load and parse CSV data using new Hugo syntax */}}
{{ $csvResource := resources.Get "deputes-active.csv" }}
{{ $csvData := $csvResource | transform.Unmarshal (dict "delimiter" ",") }}

{{/* Create a map for député lookup by normalized full name */}}
{{ $deputesLookup := dict }}
{{ range $csvData }}
  {{ if and (index . 3) (index . 4) }}
    {{/* CSV columns: nom is index 3, prenom is index 4 */}}
    {{ $nom := index . 3 }}
    {{ $prenom := index . 4 }}
    {{ $groupe := index . 8 }}
    {{ $groupeAbrev := index . 9 }}
    {{ $fullNameCSV := printf "%s %s" $prenom $nom }}
    
    {{/* Normalize CSV name: remove accents and non-letters */}}
    {{ $normalizedCSV := lower $fullNameCSV }}
    {{ $normalizedCSV = replace $normalizedCSV "á" "a" }}
    {{ $normalizedCSV = replace $normalizedCSV "à" "a" }}
    {{ $normalizedCSV = replace $normalizedCSV "â" "a" }}
    {{ $normalizedCSV = replace $normalizedCSV "ä" "a" }}
    {{ $normalizedCSV = replace $normalizedCSV "é" "e" }}
    {{ $normalizedCSV = replace $normalizedCSV "è" "e" }}
    {{ $normalizedCSV = replace $normalizedCSV "ê" "e" }}
    {{ $normalizedCSV = replace $normalizedCSV "ë" "e" }}
    {{ $normalizedCSV = replace $normalizedCSV "í" "i" }}
    {{ $normalizedCSV = replace $normalizedCSV "ì" "i" }}
    {{ $normalizedCSV = replace $normalizedCSV "î" "i" }}
    {{ $normalizedCSV = replace $normalizedCSV "ï" "i" }}
    {{ $normalizedCSV = replace $normalizedCSV "ó" "o" }}
    {{ $normalizedCSV = replace $normalizedCSV "ò" "o" }}
    {{ $normalizedCSV = replace $normalizedCSV "ô" "o" }}
    {{ $normalizedCSV = replace $normalizedCSV "ö" "o" }}
    {{ $normalizedCSV = replace $normalizedCSV "ú" "u" }}
    {{ $normalizedCSV = replace $normalizedCSV "ù" "u" }}
    {{ $normalizedCSV = replace $normalizedCSV "û" "u" }}
    {{ $normalizedCSV = replace $normalizedCSV "ü" "u" }}
    {{ $normalizedCSV = replace $normalizedCSV "ç" "c" }}
    {{ $normalizedCSV = replace $normalizedCSV "ñ" "n" }}
    {{ $normalizedCSV = replaceRE "[^a-z ]" "" $normalizedCSV }}
    {{ $normalizedCSV = replaceRE "\\s+" " " $normalizedCSV }}
    {{ $normalizedCSV = trim $normalizedCSV " " }}
    
    {{ $deputeData := dict "nom" $nom "prenom" $prenom "groupe" $groupe "groupeAbrev" $groupeAbrev }}
    {{ $deputesLookup = merge $deputesLookup (dict $normalizedCSV $deputeData) }}
  {{ end }}
{{ end }}

{{/* Create a slice to hold authors with group information */}}
{{ $authorsWithGroups := slice }}

{{/* Process each author term */}}
{{ range .Data.Terms.Alphabetical }}
  {{ $fullName := .Name }}
  {{ $nameParts := split $fullName " " }}
  {{ $lastName := index $nameParts (sub (len $nameParts) 1) }}
  
  {{/* Normalize author name: remove accents and non-letters */}}
  {{ $normalizedName := lower $fullName }}
  {{ $normalizedName = replace $normalizedName "á" "a" }}
  {{ $normalizedName = replace $normalizedName "à" "a" }}
  {{ $normalizedName = replace $normalizedName "â" "a" }}
  {{ $normalizedName = replace $normalizedName "ä" "a" }}
  {{ $normalizedName = replace $normalizedName "é" "e" }}
  {{ $normalizedName = replace $normalizedName "è" "e" }}
  {{ $normalizedName = replace $normalizedName "ê" "e" }}
  {{ $normalizedName = replace $normalizedName "ë" "e" }}
  {{ $normalizedName = replace $normalizedName "í" "i" }}
  {{ $normalizedName = replace $normalizedName "ì" "i" }}
  {{ $normalizedName = replace $normalizedName "î" "i" }}
  {{ $normalizedName = replace $normalizedName "ï" "i" }}
  {{ $normalizedName = replace $normalizedName "ó" "o" }}
  {{ $normalizedName = replace $normalizedName "ò" "o" }}
  {{ $normalizedName = replace $normalizedName "ô" "o" }}
  {{ $normalizedName = replace $normalizedName "ö" "o" }}
  {{ $normalizedName = replace $normalizedName "ú" "u" }}
  {{ $normalizedName = replace $normalizedName "ù" "u" }}
  {{ $normalizedName = replace $normalizedName "û" "u" }}
  {{ $normalizedName = replace $normalizedName "ü" "u" }}
  {{ $normalizedName = replace $normalizedName "ç" "c" }}
  {{ $normalizedName = replace $normalizedName "ñ" "n" }}
  {{ $normalizedName = replaceRE "[^a-z ]" "" $normalizedName }}
  {{ $normalizedName = replaceRE "\\s+" " " $normalizedName }}
  {{ $normalizedName = trim $normalizedName " " }}
  
  {{/* Try to find deputy info in CSV using normalized names */}}
  {{ $deputeInfo := index $deputesLookup $normalizedName }}
  {{ $groupe := "Non identifié" }}
  {{ $groupeAbrev := "NI" }}
  
  {{ if $deputeInfo }}
    {{ $groupe = $deputeInfo.groupe }}
    {{ $groupeAbrev = $deputeInfo.groupeAbrev }}
  {{ end }}
  
  {{ $authorData := dict "fullName" $fullName "lastName" $lastName "page" .Page "count" .Count "groupe" $groupe "groupeAbrev" $groupeAbrev }}
  {{ $authorsWithGroups = $authorsWithGroups | append $authorData }}
{{ end }}

{{/* Group authors by political group */}}
{{ $groupedAuthors := dict }}
{{ range $authorsWithGroups }}
  {{ $groupKey := .groupeAbrev }}
  {{ $existingGroup := index $groupedAuthors $groupKey }}
  {{ if not $existingGroup }}
    {{ $existingGroup = slice }}
  {{ end }}
  {{ $existingGroup = $existingGroup | append . }}
  {{ $groupedAuthors = merge $groupedAuthors (dict $groupKey $existingGroup) }}
{{ end }}

{{/* Define group order and display names */}}
{{ $groupOrder := slice 
  (dict "abrev" "DEM" "name" "Les Démocrates")
  (dict "abrev" "DR" "name" "Droite Républicaine")
  (dict "abrev" "ECOS" "name" "Écologiste et Social")
  (dict "abrev" "EPR" "name" "Ensemble pour la République")
  (dict "abrev" "GDR" "name" "Gauche Démocrate et Républicaine")
  (dict "abrev" "HOR" "name" "Horizons & Indépendants")
  (dict "abrev" "LFI-NFP" "name" "La France insoumise - Nouveau Front Populaire")
  (dict "abrev" "LIOT" "name" "Libertés, Indépendants, Outre-mer et Territoires")
  (dict "abrev" "RN" "name" "Rassemblement National")
  (dict "abrev" "SOC" "name" "Socialistes et apparentés") 
  (dict "abrev" "NI" "name" "Non inscrits")
}}


{{/* Load and parse groupes.csv for group colors */}}
{{ $groupesCSV := resources.Get "groupes.csv" }}
{{ $groupesData := $groupesCSV | transform.Unmarshal (dict "delimiter" ",") }}

{{/* Build a map: abrev -> couleur */}}
{{ $groupColors := dict }}
{{ range $groupesData }}
  {{ $abrev := index . 1 }}
  {{ $color := index . 2 }}
  {{ $groupColors = merge $groupColors (dict $abrev $color) }}
{{ end }}

{{/* Helper to convert hex to rgba with alpha */}}
{{/* Usage: {{ partial "hex2rgba.html" (dict "hex" $hex "alpha" 0.15) }} */}}
{{/* Place this partial in layouts/partials/hex2rgba.html */}}


{{/* Générer le CSS dynamiquement dans une variable */}}
{{ $groupCSS := "" }}
{{ range $groupOrder }}
  {{ $hex := index $groupColors .abrev }}
  {{ $hex = trim $hex " \n\r" }}
  {{ $alpha := 0.04 }}
  {{ $rgba := "rgba(200,200,200,0.15)" }}
  {{ $rgb := "#cccccc" }}
  {{ if and $hex (eq (len $hex) 7) (eq (substr $hex 0 1) "#") }}
    {{ $rHex := substr $hex 1 3 }}
    {{ $gHex := substr $hex 3 5 }}
    {{ $bHex := substr $hex 5 7 }}
    {{ $hexMap := dict "0" 0 "1" 1 "2" 2 "3" 3 "4" 4 "5" 5 "6" 6 "7" 7 "8" 8 "9" 9 "a" 10 "b" 11 "c" 12 "d" 13 "e" 14 "f" 15 "A" 10 "B" 11 "C" 12 "D" 13 "E" 14 "F" 15 }}
    {{ $r1 := default 0 (index $hexMap (lower (substr $rHex 0 1))) }}
    {{ $r2 := default 0 (index $hexMap (lower (substr $rHex 1 2))) }}
    {{ $g1 := default 0 (index $hexMap (lower (substr $gHex 0 1))) }}
    {{ $g2 := default 0 (index $hexMap (lower (substr $gHex 1 2))) }}
    {{ $b1 := default 0 (index $hexMap (lower (substr $bHex 0 1))) }}
    {{ $b2 := default 0 (index $hexMap (lower (substr $bHex 1 2))) }}
    {{ $r := add (mul $r1 16) $r2 }}
    {{ $g := add (mul $g1 16) $g2 }}
    {{ $b := add (mul $b1 16) $b2 }}
    {{ $rgba = printf "rgba(%d,%d,%d,%.2f)" $r $g $b $alpha }}
    {{ $rgb = printf "rgb(%d,%d,%d)" $r $g $b }}
  {{ end }}
  {{ $groupCSS = printf "%s.political-group.group-%s {background:%s !important;border-radius:1em;padding:1em;margin-bottom:2em;border-left:6px solid %s;}\n" $groupCSS .abrev $rgba $rgb }}
{{ end }}
<style>{{ $groupCSS | safeCSS }}</style>

{{ range $groupOrder }}
  {{ $groupAuthors := index $groupedAuthors .abrev }}
  {{ if $groupAuthors }}
    <section class="political-group group-{{ .abrev }}">
      <h2>{{ .name }}</h2>
      <ul class="terms-tags">
        {{ range sort $groupAuthors "lastName" }}
        <li>
          <a href="{{ .page.Permalink }}"
            >{{ .fullName | title }}
            <sup
              ><strong><sup>{{ .count }}</sup></strong></sup
            ></a
          >
        </li>
        {{ end }}
      </ul>
    </section>
  {{ end }}
{{ end }}

{{- end }}{{/* end main */ -}}

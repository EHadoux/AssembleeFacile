{{- define "main" }} {{- if .Title }}
<header class="page-header">
  <h1>{{ .Title }}</h1>
  {{- if .Description }}
  <div class="post-description">{{ .Description }}</div>
  {{- end }}
</header>
{{- end }} {{/* Load and parse CSV data to get deputy information */}} {{ $csvResource :=
resources.Get "deputes-active.csv" }} {{ $csvData := $csvResource | transform.Unmarshal (dict
"delimiter" ",") }} {{/* Find deputy info for current author */}} {{ $authorName := .Title }} {{
$deputeInfo := dict }} {{/* Search for deputy in CSV */}} {{ range $csvData }} {{ if and (index . 3)
(index . 4) }} {{/* CSV columns: nom is index 3, prenom is index 4 */}} {{ $nom := index . 3 }} {{
$prenom := index . 4 }} {{ $fullNameCSV := printf "%s %s" $prenom $nom }} {{/* Normalize both names
for comparison */}} {{ $normalizedCSV := lower $fullNameCSV }} {{ $normalizedAuthor := lower
$authorName }} {{/* Remove accents and special characters */}} {{ $normalizedCSV = replace
$normalizedCSV "á" "a" }} {{ $normalizedCSV = replace $normalizedCSV "à" "a" }} {{ $normalizedCSV =
replace $normalizedCSV "â" "a" }} {{ $normalizedCSV = replace $normalizedCSV "ä" "a" }} {{
$normalizedCSV = replace $normalizedCSV "é" "e" }} {{ $normalizedCSV = replace $normalizedCSV "è"
"e" }} {{ $normalizedCSV = replace $normalizedCSV "ê" "e" }} {{ $normalizedCSV = replace
$normalizedCSV "ë" "e" }} {{ $normalizedCSV = replace $normalizedCSV "í" "i" }} {{ $normalizedCSV =
replace $normalizedCSV "ì" "i" }} {{ $normalizedCSV = replace $normalizedCSV "î" "i" }} {{
$normalizedCSV = replace $normalizedCSV "ï" "i" }} {{ $normalizedCSV = replace $normalizedCSV "ó"
"o" }} {{ $normalizedCSV = replace $normalizedCSV "ò" "o" }} {{ $normalizedCSV = replace
$normalizedCSV "ô" "o" }} {{ $normalizedCSV = replace $normalizedCSV "ö" "o" }} {{ $normalizedCSV =
replace $normalizedCSV "ú" "u" }} {{ $normalizedCSV = replace $normalizedCSV "ù" "u" }} {{
$normalizedCSV = replace $normalizedCSV "û" "u" }} {{ $normalizedCSV = replace $normalizedCSV "ü"
"u" }} {{ $normalizedCSV = replace $normalizedCSV "ç" "c" }} {{ $normalizedCSV = replace
$normalizedCSV "ñ" "n" }} {{ $normalizedCSV = replaceRE "[^a-z ]" "" $normalizedCSV }} {{
$normalizedCSV = replaceRE "\\s+" " " $normalizedCSV }} {{ $normalizedCSV = trim $normalizedCSV " "
}} {{ $normalizedAuthor = replace $normalizedAuthor "á" "a" }} {{ $normalizedAuthor = replace
$normalizedAuthor "à" "a" }} {{ $normalizedAuthor = replace $normalizedAuthor "â" "a" }} {{
$normalizedAuthor = replace $normalizedAuthor "ä" "a" }} {{ $normalizedAuthor = replace
$normalizedAuthor "é" "e" }} {{ $normalizedAuthor = replace $normalizedAuthor "è" "e" }} {{
$normalizedAuthor = replace $normalizedAuthor "ê" "e" }} {{ $normalizedAuthor = replace
$normalizedAuthor "ë" "e" }} {{ $normalizedAuthor = replace $normalizedAuthor "í" "i" }} {{
$normalizedAuthor = replace $normalizedAuthor "ì" "i" }} {{ $normalizedAuthor = replace
$normalizedAuthor "î" "i" }} {{ $normalizedAuthor = replace $normalizedAuthor "ï" "i" }} {{
$normalizedAuthor = replace $normalizedAuthor "ó" "o" }} {{ $normalizedAuthor = replace
$normalizedAuthor "ò" "o" }} {{ $normalizedAuthor = replace $normalizedAuthor "ô" "o" }} {{
$normalizedAuthor = replace $normalizedAuthor "ö" "o" }} {{ $normalizedAuthor = replace
$normalizedAuthor "ú" "u" }} {{ $normalizedAuthor = replace $normalizedAuthor "ù" "u" }} {{
$normalizedAuthor = replace $normalizedAuthor "û" "u" }} {{ $normalizedAuthor = replace
$normalizedAuthor "ü" "u" }} {{ $normalizedAuthor = replace $normalizedAuthor "ç" "c" }} {{
$normalizedAuthor = replace $normalizedAuthor "ñ" "n" }} {{ $normalizedAuthor = replaceRE "[^a-z ]"
"" $normalizedAuthor }} {{ $normalizedAuthor = replaceRE "\\s+" " " $normalizedAuthor }} {{
$normalizedAuthor = trim $normalizedAuthor " " }} {{ if eq $normalizedCSV $normalizedAuthor }} {{
$deputeInfo = dict "id" (index . 0) "nom" $nom "prenom" $prenom "groupe" (index . 8) "groupeAbrev"
(index . 9) "photo" (index . 26) }} {{ end }} {{ end }} {{ end }} {{/* Display deputy information if
found */}} {{ if $deputeInfo }}
<div class="deputy-profile">
  <div class="deputy-header">
    {{ with $deputeInfo.photo }}
    <div class="deputy-photo">
      <img
        src="https://www2.assemblee-nationale.fr/static/tribun/17/photos/{{ . }}"
        alt="Photo de {{ $deputeInfo.prenom }} {{ $deputeInfo.nom }}"
        width="150"
        height="200" />
    </div>
    {{ end }}

    <div class="deputy-info">
      {{ with $deputeInfo.groupe }}
      <div class="deputy-group">
        <strong>Groupe parlementaire :</strong> {{ . }} {{ with $deputeInfo.groupeAbrev }}
        <span class="group-abbrev">({{ . }})</span>
        {{ end }}
      </div>
      {{ end }} {{ with $deputeInfo.id }}
      <div class="deputy-profile-link">
        <a
          href="https://www.assemblee-nationale.fr/dyn/deputes/{{ . }}"
          target="_blank"
          rel="noopener noreferrer">
          <span class="link-icon">→</span>
          <span class="link-text">Voir son profil officiel</span>
        </a>
      </div>
      {{ end }}
    </div>
  </div>
</div>
{{ end }} {{/* Display articles */}}
<div class="articles-section">
  <h3>Articles de {{ .Title }}</h3>

  {{/* Calculate tag distribution for pie chart */}}
  {{ $tagCounts := dict }}
  {{ $totalTags := 0 }}
  {{ range .Pages }}
    {{ $tags := .Params.tags }}
    {{ if $tags }}
      {{ range $tags }}
        {{ $tagCounts = merge $tagCounts (dict . (add (index $tagCounts . | default 0) 1)) }}
        {{ $totalTags = add $totalTags 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Display pie chart if there are tags */}}
  {{ if gt $totalTags 0 }}
  <div class="tag-distribution-chart">
    <h4>Répartition des domaines</h4>
    <div class="pie-chart-container">
      <svg class="pie-chart" viewBox="0 0 100 100">
        {{ $currentAngle := 0 }}
        {{ $sortedTags := slice }}
        {{ range $tag, $count := $tagCounts }}
          {{ $percentage := div (mul $count 100.0) $totalTags }}
          {{ $sortedTags = $sortedTags | append (dict "tag" $tag "count" $count "percentage" $percentage) }}
        {{ end }}
        {{ $sortedTags = sort $sortedTags "count" "desc" }}

        {{ $colors := slice "#e74c3c" "#3498db" "#2ecc71" "#f39c12" "#9b59b6" "#1abc9c" "#e67e22" "#34495e" "#f1c40f" "#95a5a6" "#8e44ad" "#16a085" "#27ae60" "#2980b9" "#c0392b" "#d35400" "#7f8c8d" "#2c3e50" "#e91e63" "#673ab7" }}
        {{ $colorIndex := 0 }}

        {{ range $index, $item := $sortedTags }}
          {{ if gt $item.percentage 2 }}
            {{ $angle := div (mul $item.percentage 360) 100 }}
            {{ $endAngle := add $currentAngle $angle }}
            {{ $largeArc := cond (gt $angle 180) 1 0 }}
            {{ $x1 := add 50 (mul 45 (math.Cos (div (mul $currentAngle 3.14159) 180))) }}
            {{ $y1 := add 50 (mul 45 (math.Sin (div (mul $currentAngle 3.14159) 180))) }}
            {{ $x2 := add 50 (mul 45 (math.Cos (div (mul $endAngle 3.14159) 180))) }}
            {{ $y2 := add 50 (mul 45 (math.Sin (div (mul $endAngle 3.14159) 180))) }}
            {{ $color := index $colors (mod $colorIndex (len $colors)) }}
            {{ $pathData := printf "M 50,50 L %.2f,%.2f A 45,45 0 %d,1 %.2f,%.2f z" $x1 $y1 $largeArc $x2 $y2 }}

            <path class="pie-slice" data-tag="{{ $item.tag }}" data-count="{{ $item.count }}" data-percentage="{{ printf "%.1f" $item.percentage }}" d="{{ $pathData }}" fill="{{ $color }}" stroke="#fff" stroke-width="0.5"/>

            {{ $currentAngle = $endAngle }}
            {{ $colorIndex = add $colorIndex 1 }}
          {{ end }}
        {{ end }}

        {{/* Group small tags as "Autres" */}}
        {{ $otherCount := 0 }}
        {{ $otherPercentage := 0 }}
        {{ range $sortedTags }}
          {{ if le .percentage 2 }}
            {{ $otherCount = add $otherCount .count }}
            {{ $otherPercentage = add $otherPercentage .percentage }}
          {{ end }}
        {{ end }}

        {{ if gt $otherPercentage 0 }}
          {{ $angle := div (mul $otherPercentage 360) 100 }}
          {{ $endAngle := add $currentAngle $angle }}
          {{ $largeArc := cond (gt $angle 180) 1 0 }}
          {{ $x1 := add 50 (mul 45 (math.Cos (div (mul $currentAngle 3.14159) 180))) }}
          {{ $y1 := add 50 (mul 45 (math.Sin (div (mul $currentAngle 3.14159) 180))) }}
          {{ $x2 := add 50 (mul 45 (math.Cos (div (mul $endAngle 3.14159) 180))) }}
          {{ $y2 := add 50 (mul 45 (math.Sin (div (mul $endAngle 3.14159) 180))) }}
          {{ $color := index $colors (mod $colorIndex (len $colors)) }}
          {{ $pathData := printf "M 50,50 L %.2f,%.2f A 45,45 0 %d,1 %.2f,%.2f z" $x1 $y1 $largeArc $x2 $y2 }}

          <path class="pie-slice" data-tag="Autres" data-count="{{ $otherCount }}" data-percentage="{{ printf "%.1f" $otherPercentage }}" d="{{ $pathData }}" fill="{{ $color }}" stroke="#fff" stroke-width="0.5"/>
        {{ end }}
      </svg>

      <div class="chart-tooltip" id="chart-tooltip"></div>
    </div>
  </div>

  <style>
    .tag-distribution-chart {
      margin: 2rem 0 2rem 0;
      text-align: center;
    }

    .tag-distribution-chart h4 {
      margin: 0 0 1rem 0;
      font-size: 1.3rem;
      color: var(--primary);
      text-align: center;
      font-weight: 600;
    }

    .pie-chart-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
      max-width: 225px;
    }

    .pie-chart {
      width: 100%;
      height: auto;
      max-width: 200px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    .pie-slice {
      cursor: pointer;
      transition: all 0.2s ease;
      transform-origin: 50% 50%;
    }

    .pie-slice:hover {
      filter: brightness(1.15) saturate(1.1);
      stroke-width: 1;
    }

    .chart-tooltip {
      position: absolute;
      background: var(--code-bg);
      color: var(--content);
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      white-space: nowrap;
      font-weight: 500;
    }

    .chart-tooltip.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .pie-chart-container {
        max-width: 175px;
      }

      .pie-chart {
        max-width: 160px;
      }

      .tag-distribution-chart h4 {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 480px) {
      .pie-chart-container {
        max-width: 140px;
      }

      .pie-chart {
        max-width: 130px;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const pieSlices = document.querySelectorAll('.pie-slice');
      const tooltip = document.getElementById('chart-tooltip');

      pieSlices.forEach(slice => {
        slice.addEventListener('mouseenter', function(e) {
          const tag = this.dataset.tag;
          const count = this.dataset.count;
          const percentage = this.dataset.percentage;

          tooltip.innerHTML = `<strong>${tag}</strong><br>${count} article${count > 1 ? 's' : ''} (${percentage}%)`;
          tooltip.classList.add('show');

          // Position tooltip
          const rect = this.getBoundingClientRect();
          const containerRect = document.querySelector('.pie-chart-container').getBoundingClientRect();

          tooltip.style.left = (e.clientX - containerRect.left + 15) + 'px';
          tooltip.style.top = (e.clientY - containerRect.top - 10) + 'px';
        });

        slice.addEventListener('mouseleave', function() {
          tooltip.classList.remove('show');
        });

        slice.addEventListener('mousemove', function(e) {
          if (tooltip.classList.contains('show')) {
            const containerRect = document.querySelector('.pie-chart-container').getBoundingClientRect();

            tooltip.style.left = (e.clientX - containerRect.left + 15) + 'px';
            tooltip.style.top = (e.clientY - containerRect.top - 10) + 'px';
          }
        });
      });
    });
  </script>
  {{ end }}

  {{ if .Pages }}
  {{- /* Custom sort by proposal number extracted from file name (descending) */ -}}
  {{- $sortedPages := slice }}
  {{- range .Pages }}
    {{- $proposalNum := 0 }}
    {{- $matches := findRE "n-(\\d+)" .File.BaseFileName }}
    {{- if $matches }}
      {{- $firstMatch := index $matches 0 }}
      {{- $numStr := replaceRE "n-" "" $firstMatch }}
      {{- $proposalNum = int $numStr }}
    {{- end }}
    {{- /* Create a 4-digit padded string for proper sorting, then invert for descending */ -}}
    {{- $sortKey := printf "%04d" (sub 10000 $proposalNum) }}
    {{- $sortedPages = $sortedPages | append (dict "page" . "sortKey" $sortKey) }}
  {{- end }}
  {{- $sortedPages = sort $sortedPages "sortKey" "asc" }}

  <div class="post-list">
    {{ range $sortedPages }}
    {{- $page := .page }}
    <article class="post-entry">
      {{- /* Recent post indicator - if posted within last 7 days */ -}} {{- $daysSince := div (sub
      now.Unix $page.Date.Unix) 86400 }} {{- if le $daysSince 7 }}
      <div class="recent-indicator">Nouveau</div>
      {{- end }} {{- /* Extract proposal number from title */ -}} {{- $title := $page.Title }} {{-
      $proposalNum := "" }} {{- if strings.Contains $title " - N° " }} {{- $parts := split $title "- N° " }} {{- if eq (len $parts) 2 }} {{- $proposalNum = printf "N° %s" (index $parts 1) }}
      {{- $title = index $parts 0 }} {{- end }} {{- end }}

      <header class="entry-header">
        {{- if $proposalNum }}
        <div class="proposal-badge">{{ $proposalNum }}</div>
        {{- end }}
        <h2 class="entry-hint-parent">{{- $title }}</h2>
      </header>

      <div class="entry-content-wrapper">
        {{- if $page.Summary }}
        <div class="entry-content">
          <p>{{ $page.Summary | plainify | htmlUnescape }}{{ if $page.Truncated }}...{{ end }}</p>
        </div>
        {{- end }}
      </div>

      <footer class="entry-footer">
        <div class="entry-meta-left">
          <div class="entry-date-new">
            <span style="background: #e5e7f6; color: #222; border-radius: 14px; padding: 6px 16px; font-size: 1em; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
              {{ $page.Date | time.Format ":date_long" }}
              {{- $link := $page.Param "link" }}
              {{- if $link }}
                <a href="{{ $link }}" target="_blank" rel="noopener" class="entry-link-assemblee" title="Voir sur assemblee-nationale.fr" onclick="event.stopPropagation();" style="color: #1e40af; display: inline-flex; align-items: center; position: relative; z-index: 2; pointer-events: auto;">
                  <i class="fas fa-external-link-alt"></i>
                </a>
              {{- end }}
            </span>
          </div>
          {{- $tags := $page.Params.tags }}
          {{- if $tags }}
          <div class="entry-tags-pills" style="padding: 8px 0 4px 0; display: flex; flex-wrap: wrap; gap: 8px;">
            {{- range $tags }}
              <a href="{{ "tags/" | relURL }}{{ . | urlize }}" class="tag-pill" style="background: #e0edff; color: #1e40af; border-radius: 999px; padding: 2px 12px; font-size: 0.95em; text-decoration: none; font-weight: 600; display: inline-block; position: relative; z-index: 2; pointer-events: auto;">
                {{ . }}
              </a>
            {{- end }}
          </div>
          {{- end }}
        </div>
        <div class="entry-meta-right">
          {{- $authors := $page.Param "auteurs" }}
          {{- if $authors }}
          <div class="entry-authors-enhanced">
            {{- if eq (len $authors) 1 }}
            <span>{{ index $authors 0 }}</span>
            {{- else }}
            <span>{{ index $authors 0 }} <span class="co-authors-count">+{{ sub (len $authors) 1 }}</span></span>
            {{- end }}
          </div>
          {{- end }}
          {{- $stepsName := $page.Param "stepsName" }}
          {{- $stepsStatus := $page.Param "stepsStatus" }}
          {{- if and $stepsName $stepsStatus }}
            {{- $lastIndex := sub (len $stepsName) 1 }}
            {{- $lastStepName := index $stepsName $lastIndex }}
            {{- $lastStepStatus := index $stepsStatus $lastIndex }}
            <div class="entry-status">
              <span class="step-name">{{ $lastStepName }}</span>
              {{- if strings.Contains $lastStepStatus "adopté" }}
              <span class="status-adopted">✅</span>
              {{- else if strings.Contains $lastStepStatus "rejeté" }}
              <span class="status-rejected">❌</span>
              {{- end }}
            </div>
          {{- end }}
        </div>
      </footer>

      <a
        class="entry-link"
        aria-label="post link to {{ $page.Title | plainify }}"
        href="{{ $page.Permalink }}"></a>
    </article>
    {{ end }}
  </div>
  {{ else }}
  <p>Aucun article trouvé pour cet auteur.</p>
  {{ end }}
</div>

{{- end }}{{/* end main */}}

{{- define "main" }}
{{- if (and site.Params.profileMode .IsHome) }} {{- partial
"index_profile.html" . }} {{- else }} {{/* if not profileMode */}} {{- if not .IsHome | and .Title
}}
<header class="page-header">
  {{- partial "breadcrumbs.html" . }}
  <h1>
    {{ .Title }} {{- if and (or (eq .Kind `term`) (eq .Kind `section`)) (.Param
    "ShowRssButtonInSectionTermList") }} {{- with .OutputFormats.Get "rss" }}
    <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        height="23">
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
    {{- end }} {{- end }}
  </h1>
  {{- if .Description }}
  <div class="post-description">{{ .Description | markdownify }}</div>
  {{- end }}
</header>
{{- end }} {{- if .IsHome }}
<div class="hero-section">
  <div class="hero-content">
    <h1>Assemblée Facile</h1>
    <p class="subtitle">Comprendre l'Assemblée Nationale en français simple</p>
    <p class="description">
      Découvrez les propositions de loi et débats parlementaires expliqués dans un langage accessible
      à tous les citoyens.
    </p>
  </div>
</div>
{{- end }} {{- if .Content }}
<div class="post-content">
  {{- if not (.Param "disableAnchoredHeadings") }} {{- partial "anchored_headings.html" .Content -}}
  {{- else }}{{ .Content }}{{ end }}
</div>
{{- end }} {{- $pages := union .RegularPages .Sections }} {{- if .IsHome }} {{- $pages = where
site.RegularPages "Type" "in" site.Params.mainSections }} {{- $pages = where $pages
"Params.hiddenInHomeList" "!=" "true" }} 

{{- /* Custom sort by proposal number extracted from file name (descending) */ -}}
{{- $sortedPages := slice }}
{{- range $pages }}
  {{- $proposalNum := 0 }}
  {{- $matches := findRE "n-(\\d+)" .File.BaseFileName }}
  {{- if $matches }}
    {{- $firstMatch := index $matches 0 }}
    {{- $numStr := replaceRE "n-" "" $firstMatch }}
    {{- $proposalNum = int $numStr }}
  {{- end }}
  {{- /* Create a 4-digit padded string for proper sorting, then invert for descending */ -}}
  {{- $sortKey := printf "%04d" (sub 10000 $proposalNum) }}
  {{- $sortedPages = $sortedPages | append (dict "page" . "sortKey" $sortKey) }}
{{- end }}
{{- $sortedPages = sort $sortedPages "sortKey" "asc" }}

{{- /* Convert back to pages slice */ -}}
{{- $pages = slice }}
{{- range $sortedPages }}
  {{- $pages = $pages | append .page }}
{{- end }}

{{- end }} {{- $paginator := .Paginate $pages }} {{- if and
.IsHome site.Params.homeInfoParams (eq $paginator.PageNumber 1) }} {{- partial "home_info.html" . }}
{{- end }} {{- $term := .Data.Term }} {{- range $index, $page := $paginator.Pages }} {{- $class :=
"post-entry" }} {{- $user_preferred := or site.Params.disableSpecial1stPost
site.Params.homeInfoParams }} {{- if (and $.IsHome (eq $paginator.PageNumber 1) (eq $index 0) (not
$user_preferred)) }} {{- $class = "first-entry" }} {{- else if $term }} {{- $class = "post-entry tag-entry" }} {{- end }}

<article class="{{ $class }}">
  {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param "cover.hidden") | default false
  }} {{- partial "cover.html" (dict "cxt" . "IsSingle" false "isHidden" $isHidden) }}

  {{- /* Recent post indicator - if posted within last 7 days */ -}}
  {{- $daysSince := div (sub now.Unix .Date.Unix) 86400 }}
  {{- if le $daysSince 7 }}
  <div class="recent-indicator">Nouveau</div>
  {{- end }}

  <header class="entry-header">
    {{- /* Extract proposal number from title */ -}} {{- $title := .Title }} {{- $proposalNum := ""
    }} {{- if strings.Contains $title " - N° " }} {{- $parts := split $title " - N° " }} {{- if eq
    (len $parts) 2 }} {{- $proposalNum = printf "N° %s" (index $parts 1) }} {{- $title = index
    $parts 0 }} {{- end }} {{- end }} {{- if $proposalNum }}
    <div class="proposal-badge">{{ $proposalNum }}</div>
    {{- end }}

    <h2 class="entry-hint-parent">
      {{- $title }} {{- if .Draft }}
      <span class="entry-hint" title="Draft">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="20"
          viewBox="0 -960 960 960"
          fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
      {{- end }}
    </h2>
  </header>

  <div class="entry-content-wrapper">
    {{- if (ne (.Param "hideSummary") true) }}
    <div class="entry-content">
      <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
    </div>
    {{- end }}
  </div>

  {{- if not (.Param "hideMeta") }}
  <footer class="entry-footer">
    <div class="entry-meta-left">
      <div class="entry-date-new">
        {{ .Date.Format "2 janvier 2006" }}
        {{- $link := .Param "link" }}
        {{- if $link }}
        <a href="{{ $link }}" target="_blank" rel="noopener" class="entry-link-assemblee" title="Voir sur assemblee-nationale.fr" onclick="event.stopPropagation();" style="position: relative; z-index: 10; margin-left: 8px;">
          <i class="fas fa-external-link-alt"></i>
        </a>
        {{- end }}
      </div>
    </div>
    <div class="entry-meta-right">
      {{- $authors := .Param "auteurs" }}
      {{- if $authors }}
      <div class="entry-authors-enhanced">
        {{- if eq (len $authors) 1 }}
        <span>{{ index $authors 0 }}</span>
        {{- else }}
        <span>{{ index $authors 0 }} <span class="co-authors-count">+{{ sub (len $authors) 1 }}</span></span>
        {{- end }}
      </div>
      {{- end }}
      {{- $stepsName := .Param "stepsName" }}
      {{- $stepsStatus := .Param "stepsStatus" }}
      {{- if and $stepsName $stepsStatus }}
        {{- $lastIndex := sub (len $stepsName) 1 }}
        {{- $lastStepName := index $stepsName $lastIndex }}
        {{- $lastStepStatus := index $stepsStatus $lastIndex }}
        <div class="entry-status">
          <span class="step-name">{{ $lastStepName }}</span>
          {{- if strings.Contains $lastStepStatus "adopté" }}
          <span class="status-adopted">✅</span>
          {{- else if strings.Contains $lastStepStatus "rejeté" }}
          <span class="status-rejected">❌</span>
          {{- end }}
        </div>
      {{- end }}
    </div>
  </footer>
  {{- end }}

  <a
    class="entry-link"
    aria-label="post link to {{ .Title | plainify }}"
    href="{{ .Permalink }}"></a>
</article>
{{- end }} {{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer">
  <nav class="pagination">
    {{- if $paginator.HasPrev }}
    <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
      «&nbsp;{{ i18n "prev_page" }}&nbsp; {{- if (.Param "ShowPageNums") }} {{- sub
      $paginator.PageNumber 1 }}/{{ $paginator.TotalPages }} {{- end }}
    </a>
    {{- end }} {{- if $paginator.HasNext }}
    <a class="next" href="{{ $paginator.Next.URL | absURL }}">
      {{- i18n "next_page" }}&nbsp; {{- if (.Param "ShowPageNums") }} {{- add 1
      $paginator.PageNumber }}/{{ $paginator.TotalPages }} {{- end }}&nbsp;»
    </a>
    {{- end }}
  </nav>
</footer>
{{- end }} {{- end }}{{/* end profileMode */}} {{- end }}{{- /* end main */ -}}

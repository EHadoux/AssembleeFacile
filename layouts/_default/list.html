{{- define "main" }}
{{- if (and site.Params.profileMode .IsHome) }} 
{{- partial "index_profile.html" . }} 
{{- else }} {{/* if not profileMode */}} 

{{- if .IsHome }}
<div class="hero-section">
  <div class="hero-content">
    <h1>Assemblée Facile</h1>
    <p class="subtitle">Comprendre l'Assemblée Nationale en français simple</p>
    <p class="description">
      Découvrez les propositions de loi et débats parlementaires expliqués dans un langage accessible
      à tous les citoyens.
    </p>
  </div>
</div>
{{- end }}

<div class="content-container">
  <div class="main-content{{ if eq .Kind "term" }} full-width{{ end }}">
    {{- if not .IsHome | and .Title }}
    <header class="page-header">
      {{- partial "breadcrumbs.html" . }}
      <h1>
        {{ .Title }} {{- if and (or (eq .Kind `term`) (eq .Kind `section`)) (.Param
        "ShowRssButtonInSectionTermList") }} {{- with .OutputFormats.Get "rss" }}
        <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            height="23">
            <path d="M4 11a9 9 0 0 1 9 9" />
            <path d="M4 4a16 16 0 0 1 16 16" />
            <circle cx="5" cy="19" r="1" />
          </svg>
        </a>
        {{- end }} {{- end }}
      </h1>
      {{- if .Description }}
      <div class="post-description">{{ .Description | markdownify }}</div>
      {{- end }}
    </header>
    {{- end }} {{- if .Content }}
<div class="post-content">
  {{- if not (.Param "disableAnchoredHeadings") }} {{- partial "anchored_headings.html" .Content -}}
  {{- else }}{{ .Content }}{{ end }}
</div>
{{- end }} {{- $pages := union .RegularPages .Sections }} {{- if .IsHome }} {{- $pages = where
site.RegularPages "Type" "in" site.Params.mainSections }} {{- $pages = where $pages
"Params.hiddenInHomeList" "!=" "true" }} {{- end }}

{{- /* Sort by proposal number extracted from filename (descending) */ -}}
{{- $sortedPages := slice }}
{{- range $pages }}
  {{- $proposalNum := 0 }}
  {{- $basename := .File.BaseFileName }}
  {{- $matches := findRE "n-(\\d+)$" $basename }}
  {{- if $matches }}
    {{- $match := index $matches 0 }}
    {{- $numStr := replaceRE "n-" "" $match }}
    {{- $proposalNum = int $numStr }}
  {{- end }}
  {{- $sortedPages = $sortedPages | append (dict "page" . "proposalNum" $proposalNum) }}
{{- end }}
{{- $sortedPages = sort $sortedPages "proposalNum" "desc" }}

{{- /* Convert back to pages slice */ -}}
{{- $pages = slice }}
{{- range $sortedPages }}
  {{- $pages = $pages | append .page }}
{{- end }}

{{- $paginator := .Paginate $pages }}

{{- /* Determine if sidebar should be shown */ -}}
{{- $showSidebar := and (ne .Kind "term") (eq $paginator.PageNumber 1) }}

{{- if and
.IsHome site.Params.homeInfoParams (eq $paginator.PageNumber 1) }} {{- partial "home_info.html" . }}
{{- end }}

{{- $term := .Data.Term }} {{- range $index, $page := $paginator.Pages }} {{- $class :=
"post-entry" }} {{- $user_preferred := or site.Params.disableSpecial1stPost
site.Params.homeInfoParams }} {{- if (and $.IsHome (eq $paginator.PageNumber 1) (eq $index 0) (not
$user_preferred)) }} {{- $class = "first-entry" }} {{- else if $term }} {{- $class = "post-entry tag-entry" }} {{- end }}

<article class="{{ $class }}" style="position: relative;">
  {{- $isHidden := ($page.Param "cover.hiddenInList") | default ($page.Param "cover.hidden") | default false
  }} {{- partial "cover.html" (dict "cxt" $page "IsSingle" false "isHidden" $isHidden) }}

  {{- /* Recent post indicator - if posted within last 7 days */ -}}
  {{- $daysSince := div (sub now.Unix $page.Date.Unix) 86400 }}
  {{- if le $daysSince 7 }}
  <div class="recent-indicator">Nouveau</div>
  {{- end }}

  <header class="entry-header">
    {{- /* Extract proposal number from title */ -}} {{- $title := $page.Title }} {{- $proposalNum := ""
    }} {{- if strings.Contains $title " - N° " }} {{- $parts := split $title " - N° " }} {{- if eq
    (len $parts) 2 }} {{- $proposalNum = printf "N° %s" (index $parts 1) }} {{- $title = index
    $parts 0 }} {{- end }} {{- end }} {{- if $proposalNum }}
    <div class="proposal-badge">{{ $proposalNum }}</div>
    {{- end }}

    <h2 class="entry-hint-parent">
      {{- $title }} {{- if $page.Draft }}
      <span class="entry-hint" title="Draft">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="20"
          viewBox="0 0 24 24"
          fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
      {{- end }}
    </h2>
  </header>

  <div class="entry-content-wrapper">
    {{- if (ne ($page.Param "hideSummary") true) }}
    <div class="entry-content">
      <p>{{ $page.Summary | plainify | htmlUnescape }}{{ if $page.Truncated }}...{{ end }}</p>
    </div>
    {{- end }}
  </div>

  {{- if not ($page.Param "hideMeta") }}
  <footer class="entry-footer">
    <div class="entry-meta-left">
      <div class="entry-date-new">
        <span style="background: #e5e7f6; color: #222; border-radius: 14px; padding: 6px 16px 6px 16px; font-size: 1em; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
          {{ $page.Date | time.Format ":date_long" }}
          {{- $link := $page.Param "link" }}
          {{- if $link }}
            <a href="{{ $link }}" target="_blank" rel="noopener" class="entry-link-assemblee" title="Voir sur assemblee-nationale.fr" onclick="event.stopPropagation();" style="color: #1e40af; margin-left: 0; display: inline-flex; align-items: center; position: relative; z-index: 2; pointer-events: auto;">
              <i class="fas fa-external-link-alt"></i>
            </a>
          {{- end }}
        </span>
      </div>
      {{- $tags := $page.Params.tags }}
      {{- if $tags }}
      <div class="entry-tags-pills" style="padding: 8px 0 4px 0; display: flex; flex-wrap: wrap; gap: 8px;">
        {{- range $tags }}
          <a href="{{ "tags/" | relURL }}{{ . | urlize }}" class="tag-pill" style="background: #e0edff; color: #1e40af; border-radius: 999px; padding: 2px 12px; font-size: 0.95em; text-decoration: none; font-weight: 600; display: inline-block; position: relative; z-index: 2; pointer-events: auto;">
            {{ . }}
          </a>
        {{- end }}
      </div>
      {{- end }}
    </div>
    <div class="entry-meta-right">
      {{- $authors := $page.Param "auteurs" }}
      {{- if $authors }}
      <div class="entry-authors-enhanced">
        {{- if eq (len $authors) 1 }}
        <span>{{ index $authors 0 }}</span>
        {{- else }}
        <span>{{ index $authors 0 }} <span class="co-authors-count">+{{ sub (len $authors) 1 }}</span></span>
        {{- end }}
      </div>
      {{- end }}
      {{- $stepsName := $page.Param "stepsName" }}
      {{- $stepsStatus := $page.Param "stepsStatus" }}
      {{- if and $stepsName $stepsStatus }}
        {{- $lastIndex := sub (len $stepsName) 1 }}
        {{- $lastStepName := index $stepsName $lastIndex }}
        {{- $lastStepStatus := index $stepsStatus $lastIndex }}
        <div class="entry-status">
          <span class="step-name">{{ $lastStepName }}</span>
          {{- if strings.Contains $lastStepStatus "adopté" }}
          <span class="status-adopted">✅</span>
          {{- else if strings.Contains $lastStepStatus "rejeté" }}
          <span class="status-rejected">❌</span>
          {{- end }}
        </div>
      {{- end }}
    </div>
  </footer>
  {{- end }}

  <a
    class="entry-link"
    aria-label="post link to {{ $page.Title | plainify }}"
    href="{{ $page.Permalink }}"
    style="position: absolute; inset: 0; z-index: 1;"></a>
</article>
{{- end }} 

  </div>
  
  {{- if $showSidebar }}
  <div class="sidebar">

    {{/* Charger les données CSV */}}
    {{- $deputesData := slice }}
    {{- $groupesData := slice }}
    
    {{/* Parser le fichier députés avec transform.Unmarshal */}}
    {{- $deputesFile := resources.Get "deputes-active.csv" }}
    {{- if $deputesFile }}
      {{- $opts := dict "delimiter" "," }}
      {{- $deputesRaw := $deputesFile | transform.Unmarshal $opts }}
      {{- if gt (len $deputesRaw) 1 }}
        {{/* Ignorer la première ligne (headers) */}}
        {{- range after 1 $deputesRaw }}
          {{- if ge (len .) 10 }}
            {{- $nom := index . 3 }}
            {{- $prenom := index . 4 }}
            {{- $groupe := index . 8 }}
            {{- $nomComplet := printf "%s %s" $prenom $nom }}
            {{- $deputesData = $deputesData | append (dict "nom" $nomComplet "groupe" $groupe) }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    
    {{/* Parser le fichier groupes avec transform.Unmarshal */}}
    {{- $groupesFile := resources.Get "groupes.csv" }}
    {{- if $groupesFile }}
      {{- $opts := dict "delimiter" "," }}
      {{- $groupesRaw := $groupesFile | transform.Unmarshal $opts }}
      {{- if gt (len $groupesRaw) 1 }}
        {{/* Ignorer la première ligne (headers) */}}
        {{- range after 1 $groupesRaw }}
          {{- if ge (len .) 3 }}
            {{- $groupeNom := index . 0 }}
            {{- $couleur := index . 2 }}
            {{- if and $groupeNom $couleur }}
              {{- $groupesData = $groupesData | append (dict "nom" $groupeNom "couleur" $couleur) }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{/* 10 plus gros contributeurs */}}
    {{- $auteurCounts := dict }}
    {{- range site.RegularPages }}
      {{- $auteurs := .Param "auteurs" }}
      {{- if $auteurs }}
        {{- range $auteurs }}
          {{- $count := index $auteurCounts . | default 0 }}
          {{- $auteurCounts = merge $auteurCounts (dict . (add $count 1)) }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- $sortedAuteurs := slice }}
    {{- range $auteur, $count := $auteurCounts }}
      {{/* Trouver le groupe politique de cet auteur */}}
      {{- $auteurGroupe := "" }}
      {{- $groupeCouleur := "" }}
      {{- range $deputesData }}
        {{- if eq .nom $auteur }}
          {{- $auteurGroupe = .groupe }}
          {{/* Trouver la couleur du groupe */}}
          {{- range $groupesData }}
            {{- if eq .nom $auteurGroupe }}
              {{- $groupeCouleur = .couleur }}
              {{- break }}
            {{- end }}
          {{- end }}
          {{- break }}
        {{- end }}
      {{- end }}
      {{- $sortedAuteurs = $sortedAuteurs | append (dict "nom" $auteur "count" $count "groupe" $auteurGroupe "couleur" $groupeCouleur) }}
    {{- end }}
    {{- $sortedAuteurs = sort $sortedAuteurs "count" "desc" }}
    {{- $top10Auteurs := first 10 $sortedAuteurs }}

    <div class="stat-item">
      <h4>10 plus gros contributeurs</h4>
      <div class="top-authors">
        {{- range $index, $auteur := $top10Auteurs }}
        <div class="author-item">
          <span class="author-rank">{{ add $index 1 }}.</span>
          <div class="author-info">
            <div class="author-name-line">
              <a href="{{ printf "/auteurs/%s/" ($auteur.nom | urlize) | relURL }}" class="author-name">{{ $auteur.nom }}</a>
              <span class="author-count">({{ $auteur.count }})</span>
            </div>
            {{- if and $auteur.groupe $auteur.couleur (ne (lower $auteur.groupe) "non inscrits") }}
            <span class="author-party" style="background-color: {{ $auteur.couleur }};">{{ $auteur.groupe }}</span>
            {{- end }}
          </div>
        </div>
        {{- end }}
      </div>
    </div>

    <!-- {{/* Contributions par parti */}}
    {{- $contributionsByParty := dict }}
    {{- range site.RegularPages }}
      {{- $auteurs := .Param "auteurs" }}
      {{- if $auteurs }}
        {{- $pageParties := slice }}
        {{- range $auteurs }}
          {{- $auteurGroupe := "" }}
          {{- range $deputesData }}
            {{- if eq .nom . }}
              {{- $auteurGroupe = .groupe }}
              {{- break }}
            {{- end }}
          {{- end }}
          {{- if $auteurGroupe }}
            {{- if and (ne (lower $auteurGroupe) "non inscrits") (not (in $pageParties $auteurGroupe)) }}
              {{- $pageParties = $pageParties | append $auteurGroupe }}
            {{- end }}
          {{- else }}
            {{- if or (strings.Contains . "Président") (strings.Contains . "Sénat") }}
              {{- if not (in $pageParties "Sénat") }}
                {{- $pageParties = $pageParties | append "Sénat" }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- range $pageParties }}
          {{- $currentCount := index $contributionsByParty . | default 0 }}
          {{- $contributionsByParty = merge $contributionsByParty (dict . (add $currentCount 1)) }}
        {{- end }}
      {{- end }}
    {{- end }} -->

    <!-- {{- $sortedParties := slice }}
    {{- range $party, $count := $contributionsByParty }}
      {{- $partyCouleur := "" }}
      {{- range $groupesData }}
        {{- if eq .nom $party }}
          {{- $partyCouleur = .couleur }}
          {{- break }}
        {{- end }}
      {{- end }}
      {{- $sortedParties = $sortedParties | append (dict "nom" $party "count" $count "couleur" $partyCouleur) }}
    {{- end }}
    {{- $sortedParties = sort $sortedParties "count" "desc" }} -->

    <!-- <div class="stat-item">
      <h4>Contributions par parti</h4>
      <div class="party-contributions">
        {{- range $party := $sortedParties }}
        <div class="party-item">
          <div class="party-name-line">
            {{- if $party.couleur }}
            <span class="party-badge" style="background-color: {{ $party.couleur }};">{{ $party.nom }}</span>
            {{- else }}
            <span class="party-name">{{ $party.nom }}</span>
            {{- end }}
            <span class="party-count">{{ $party.count }}</span>
          </div>
        </div>
        {{- end }}
      </div>
    </div> -->

  </div>
  {{- end }}
</div>

{{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer" style="border: 0px; margin-top: 1em; background: none">
  <nav class="pagination">
    {{- if $paginator.HasPrev }}
    <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
      «&nbsp;{{ i18n "prev_page" }}
    </a>
    {{- end }}

    <div class="pagination-numbers">
      {{- /* Page numbers */ -}}
      {{- $currentPage := $paginator.PageNumber }}
      {{- $totalPages := $paginator.TotalPages }}
      {{- $showRange := 2 }}
      {{- $startPage := sub $currentPage $showRange }}
      {{- $endPage := add $currentPage $showRange }}

      {{- if lt $startPage 1 }}
      {{- $startPage = 1 }}
      {{- end }}
      {{- if gt $endPage $totalPages }}
      {{- $endPage = $totalPages }}
      {{- end }}

      {{- /* Show first page if not in range */ -}}
      {{- if gt $startPage 2 }}
      <a href="{{ .Paginator.First.URL | absURL }}">1</a>
      {{- if gt $startPage 3 }}
      <span class="pagination-ellipsis">…</span>
      {{- end }}
      {{- end }}

      {{- /* Show page numbers in range */ -}}
      {{- range $pageNum := seq $startPage $endPage }}
      {{- if eq $pageNum $currentPage }}
      <span class="pagination-current">{{ $pageNum }}</span>
      {{- else }}
      {{- if eq $pageNum 1 }}
      <a href="{{ $.Paginator.First.URL | absURL }}">{{ $pageNum }}</a>
      {{- else }}
      <a href="{{ printf "/page/%d/" $pageNum | absURL }}">{{ $pageNum }}</a>
      {{- end }}
      {{- end }}
      {{- end }}

      {{- /* Show last page if not in range */ -}}
      {{- if lt $endPage (sub $totalPages 1) }}
      {{- if lt $endPage (sub $totalPages 2) }}
      <span class="pagination-ellipsis">…</span>
      {{- end }}
      <a href="{{ .Paginator.Last.URL | absURL }}">{{ $totalPages }}</a>
      {{- end }}
    </div>

    {{- if $paginator.HasNext }}
    <a class="next" href="{{ $paginator.Next.URL | absURL }}">
      {{ i18n "next_page" }}&nbsp;»
    </a>
    {{- end }}
  </nav>
</footer>
{{- end }}

<script>
// Auto-detect if sidebar is missing and apply full-width layout
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.content-container');
  const sidebar = document.querySelector('.sidebar');
  
  if (container && !sidebar) {
    container.classList.add('no-sidebar');
  }
});
</script>

{{- end }}{{/* end profileMode */}} 
{{- end }}{{/* end main */}}

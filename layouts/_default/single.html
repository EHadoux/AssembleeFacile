{{- define "main" }}

<style>
/* Status Section Styles */
.status-current-section {
    margin-bottom: 20px;
}

.status-current-content {
    padding: 10px 15px; /* Reduced padding */
    border-radius: 8px;
    border-left: 5px solid;
}

.status-adopted {
    background-color: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
}

.status-rejected {
    background-color: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
}

.status-pending {
    background-color: rgba(255, 193, 7, 0.1);
    border-color: #ffc107;
}

.status-current-main {
    font-size: 1.1em; /* Reduced font size */
    font-weight: bold;
}

.status-current-details {
    margin-top: 2px; /* Reduced margin */
    font-size: 0.9em;
    color: var(--secondary);
}

/* History Table Styles */
.status-history-section {
    margin-top: 20px;
    margin-bottom: 20px; /* Added margin-bottom */
}

.status-history-toggle {
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
}

.status-history-toggle .toggle-arrow {
    margin-left: 8px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.8em; /* Further reduced font size */
}

.history-table td {
    padding: 2px 4px; /* Further reduced padding */
    border: none !important; /* Removed all borders */
}

.status-text-success {
    color: #28a745;
    font-weight: bold;
}

.status-text-danger {
    color: #dc3545;
    font-weight: bold;
}

.status-text-pending {
    color: #6c757d;
}

.status-icon-fa {
    margin-right: 5px;
}

/* Political Spectrum Styles */
.political-spectrum-container {
    margin-bottom: 20px;
    margin-top: 20px;
}

.political-spectrum-title {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--content);
    margin-bottom: 8px;
    text-align: left;
}

.political-spectrum {
  display: flex;
  width: 100%;
  height: 20px;
  border-radius: 4px;
  overflow: hidden;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
}

.spectrum-segment {
  height: 100%;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

.spectrum-segment:not(:last-child) {
    border-right: 1px solid #ccc;
}

.spectrum-fill {
  height: 100%;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

/* Political Distribution Table Styles */
.political-distribution-table {
  margin-top: 1.5rem;
}

.political-distribution-table h4 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--primary);
  margin: 0 0 1rem 0;
}

.parties-table {
  width: fit-content;
  border-collapse: collapse;
  font-size: 0.9rem;
  background: var(--entry);
  border-radius: 8px;
  overflow: hidden;
  margin: auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.parties-table th,
.parties-table td {
  padding: 0.75rem 1rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.parties-table th {
  background: var(--theme);
  color: var(--content);
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.parties-table tr:last-child td {
  border-bottom: none;
}

.parties-table tr:hover {
  background: var(--hljs-bg);
}

.party-name {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 500;
}

.party-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.party-present {
  text-align: center;
  font-weight: 600;
  color: var(--primary);
}

.party-total {
  text-align: center;
  color: var(--secondary);
}

@media (max-width: 768px) {
  .parties-table {
    font-size: 0.85rem;
  }
  
  .parties-table th,
  .parties-table td {
    padding: 0.6rem 0.8rem;
  }
  
  .political-distribution-table h4 {
    font-size: 1rem;
  }
}

/* Custom Tooltip Styles */
.custom-tooltip {
  position: absolute;
  background-color: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  white-space: nowrap;
  z-index: 1000;
  pointer-events: none;
  opacity: 0;
  transform: translateY(-100%);
  transition: opacity 0.2s ease-in-out;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

.custom-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 3px solid transparent;
  border-top-color: rgba(0, 0, 0, 0.9);
}

.custom-tooltip.show {
  opacity: 1;
}
</style>

<article class="post-single">
  <header class="post-header">
    {{ partial "breadcrumbs.html" . }} {{- /* Extract proposal number from title */ -}} {{- $title
    := .Title }} {{- $proposalNum := "" }} {{- if strings.Contains $title " - N° " }} {{- $parts :=
    split $title " - N° " }} {{- if eq (len $parts) 2 }} {{- $proposalNum = printf "N° %s" (index
    $parts 1) }} {{- $title = index $parts 0 }} {{- end }} {{- end }} {{- if $proposalNum }}
    <div class="post-proposal-badge">{{ $proposalNum }}</div>
    {{- end }}

    <h1 class="post-title entry-hint-parent">
      {{ $title }} {{- if .Draft }}
      <span class="entry-hint" title="Draft">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="35"
          viewBox="0 -960 960 960"
          fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
      {{- end }}
    </h1>

    {{- if .Description }}
    <div class="post-description">{{ .Description }}</div>
    {{- end }}
    
    <div class="post-header-meta">
      <time class="post-date">{{ .Date | time.Format ":date_long" }}</time>
      {{- $link := .Param "link" }}
      {{- if $link }}
      <a href="{{ $link }}" target="_blank" rel="noopener" class="post-assemblee-link-compact" title="Voir le document officiel sur assemblee-nationale.fr" style="margin-left: 8px;">
        <i class="fas fa-external-link-alt"></i>
      </a>
      {{- end }}
    </div>

    {{/* Utiliser le parsing CSV natif de Hugo */}}
    {{- $deputesData := slice }}
    {{- $groupesData := slice }}
    
    {{/* Parser le fichier députés avec transform.Unmarshal */}}
    {{- $deputesFile := resources.Get "deputes-active.csv" }}
    {{- if $deputesFile }}
      {{- $opts := dict "delimiter" "," }}
      {{- $deputesRaw := $deputesFile | transform.Unmarshal $opts }}
      {{- if gt (len $deputesRaw) 1 }}
        {{/* Ignorer la première ligne (headers) */}}
        {{- range after 1 $deputesRaw }}
          {{- if ge (len .) 10 }}
            {{- $nom := index . 3 }}
            {{- $prenom := index . 4 }}
            {{- $groupe := index . 8 }}
            {{- $nomComplet := printf "%s %s" $prenom $nom }}
            {{- $deputesData = $deputesData | append (dict "nom" $nomComplet "groupe" $groupe) }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    
    {{/* Parser le fichier groupes avec transform.Unmarshal */}}
    {{- $groupesFile := resources.Get "groupes.csv" }}
    {{- if $groupesFile }}
      {{- $opts := dict "delimiter" "," }}
      {{- $groupesRaw := $groupesFile | transform.Unmarshal $opts }}
      {{- if gt (len $groupesRaw) 1 }}
        {{/* Ignorer la première ligne (headers) */}}
        {{- range after 1 $groupesRaw }}
          {{- if ge (len .) 3 }}
            {{- $groupeNom := index . 0 }}
            {{- $couleur := index . 2 }}
            {{- if and $groupeNom $couleur }}
              {{- $groupesData = $groupesData | append (dict "nom" $groupeNom "couleur" $couleur) }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- if and (gt (len $deputesData) 0) (gt (len $groupesData) 0) }}

      {{/* Compter le nombre total de députés par groupe */}}
      {{- $totalDeputesParGroupe := dict }}
      {{- $totalDeputes := 0 }}
      {{- range $deputesData }}
        {{- $groupe := .groupe }}
        {{- if and $groupe (ne (lower $groupe) "non inscrits") }}
          {{- $count := index $totalDeputesParGroupe $groupe | default 0 }}
          {{- $totalDeputesParGroupe = merge $totalDeputesParGroupe (dict $groupe (add $count 1)) }}
          {{- $totalDeputes = add $totalDeputes 1 }}
        {{- end }}
      {{- end }}
      
      {{/* Analyser les auteurs de ce post */}}
      {{- $auteurGroupes := slice }}
      {{- $auteursValides := 0 }}
      
      {{- range .Params.auteurs }}
        {{- $auteurNom := . }}
        {{- $auteurGroupe := "" }}
        
        {{- range $deputesData }}
          {{- if eq .nom $auteurNom }}
            {{- $auteurGroupe = .groupe }}
            {{- break }}
          {{- end }}
        {{- end }}
        
        {{- if and $auteurGroupe (ne $auteurGroupe "") (ne (lower $auteurGroupe) "non inscrits") }}
          {{- $auteurGroupes = $auteurGroupes | append $auteurGroupe }}
          {{- $auteursValides = add $auteursValides 1 }}
        {{- end }}
      {{- end }}
      
      {{/* Afficher la barre seulement s'il y a des auteurs valides */}}
      {{- if gt $auteursValides 0 }}
        {{/* Compter les auteurs par groupe */}}
        {{- $groupeCounts := dict }}
        {{- range $auteurGroupes }}
          {{- $count := index $groupeCounts . | default 0 }}
          {{- $groupeCounts = merge $groupeCounts (dict . (add $count 1)) }}
        {{- end }}
        
        <div class="political-spectrum-container">
          <div class="political-spectrum-title">Répartition politique des présentateurs</div>
          <div class="political-spectrum">
            {{- range $groupesData }}
              {{- $groupeNom := .nom }}
              {{- $totalGroupe := index $totalDeputesParGroupe $groupeNom | default 0 }}
              
              {{- if gt $totalGroupe 0 }}
                {{- $couleur := .couleur }}
                {{- $auteursGroupe := index $groupeCounts $groupeNom | default 0 }}
                
                {{- $largeurSegment := 0 }}
                {{- if gt $totalDeputes 0 }}
                  {{- $largeurSegment = mul (div (float $totalGroupe) (float $totalDeputes)) 100.0 }}
                {{- end }}

                {{- $remplissage := 0 }}
                {{- if gt $totalGroupe 0 }}
                  {{- $remplissage = mul (div (float $auteursGroupe) (float $totalGroupe)) 100.0 }}
                {{- end }}
                
                <div class="spectrum-segment" 
                     style="width: {{ $largeurSegment }}%;"
                     data-tooltip="{{ $groupeNom }}: {{ $auteursGroupe }} auteur(s) sur {{ $totalGroupe }} député(s)">
                  <div class="spectrum-fill" 
                       style="width: {{ $remplissage }}%; background-color: {{ $couleur }};">
                  </div>
                </div>
              {{- end }}
            {{- end }}
          </div>
        </div>
        
        {{/* Political distribution table */}}
        <div class="political-distribution-table">
          <h4>Répartition par parti</h4>
          <table class="parties-table">
            <thead>
              <tr>
                <th>Parti</th>
                <th>Signataires</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {{- range $groupesData }}
                {{- $groupeNom := .nom }}
                {{- $totalGroupe := index $totalDeputesParGroupe $groupeNom | default 0 }}
                {{- $auteursGroupe := index $groupeCounts $groupeNom | default 0 }}
                
                {{- if and (gt $totalGroupe 0) (gt $auteursGroupe 0) }}
                  <tr>
                    <td class="party-name">
                      <span class="party-color" style="background-color: {{ .couleur }};"></span>
                      {{ $groupeNom }}
                    </td>
                    <td class="party-present">{{ $auteursGroupe }}</td>
                    <td class="party-total">{{ $totalGroupe }}</td>
                  </tr>
                {{- end }}
              {{- end }}
            </tbody>
          </table>
        </div>
      {{- end }}
    {{- end }}
  </header>
  
  {{- $stepsName := .Param "stepsName" }}
  {{- $stepsDate := .Param "stepsDate" }}
  {{- $stepsStatus := .Param "stepsStatus" }}
  {{- if and $stepsName $stepsDate $stepsStatus }}
  <div class="post-content">
    {{- $lastIndex := sub (len $stepsName) 1 }}
    {{- $lastStepName := index $stepsName $lastIndex }}
    {{- $lastStepDate := index $stepsDate $lastIndex }}
    {{- $lastStepStatus := index $stepsStatus $lastIndex }}
    
    <h2>Statut du texte</h2>
    
    <div class="status-current-section">
      {{- $statusClass := "" }}
      {{- $statusText := $lastStepStatus | default "En cours" }}
      {{- if strings.Contains $statusText "adopté" }}
        {{- $statusClass = "status-adopted" }}
      {{- else if strings.Contains $statusText "rejeté" }}
        {{- $statusClass = "status-rejected" }}
      {{- else }}
        {{- $statusClass = "status-pending" }}
      {{- end }}
      
      <div class="status-current-content {{ $statusClass }}">
        <div class="status-current-main">
          <span class="status-text">{{ $statusText }}</span>
        </div>
        <div class="status-current-details">
          {{ $lastStepName }} - {{ $lastStepDate }}
        </div>
      </div>
    </div>
    
    {{- if gt (len $stepsName) 1 }}
    <div class="status-history-section">
      <details class="status-history">
        <summary class="status-history-toggle">
          <span class="toggle-text">Historique complet</span>
          <span class="toggle-arrow">▼</span>
        </summary>
        <div class="status-history-content">
          <table class="history-table">
            {{- range $index, $stepName := $stepsName }}
              {{- if lt $index $lastIndex }}
              {{- $stepDate := index $stepsDate $index }}
              {{- $stepStatus := index $stepsStatus $index }}
              <tr class="history-row">
                <td>{{ $stepName }}</td>
                <td>{{ $stepDate }}</td>
                <td>
                  {{- $statusText := $stepStatus | default "" }}
                  {{- $statusClass := "" }}
                  {{- $statusIcon := "" }}
                  {{- $displayText := $statusText }}
                  {{- if strings.Contains $statusText "adopté" }}
                    {{- $statusClass = "status-text-success" }}
                    {{- $statusIcon = "<i class='fas fa-check-circle status-icon-fa'></i>" }}
                    {{- $displayText = strings.Replace $displayText "✔️" "" }}
                  {{- else if strings.Contains $statusText "rejeté" }}
                    {{- $statusClass = "status-text-danger" }}
                    {{- $statusIcon = "<i class='fas fa-times-circle status-icon-fa'></i>" }}
                    {{- $displayText = strings.Replace $displayText "❌" "" }}
                  {{- else }}
                    {{- $statusClass = "status-text-pending" }}
                  {{- end }}
                  <span class="{{ $statusClass }}">{{- if $statusIcon }}{{ $statusIcon | safeHTML }}{{- end }}{{ trim $displayText " " }}</span>
                </td>
              </tr>
              {{- end }}
            {{- end }}
          </table>
        </div>
      </details>
    </div>
    {{- end }}
  </div>
  {{- end }}
  {{- $isHidden := (.Param "cover.hiddenInSingle") | default (.Param "cover.hidden") | default false
  }} {{- partial "cover.html" (dict "cxt" . "IsSingle" true "isHidden" $isHidden) }} {{- if (.Param
  "ShowToc") }} {{- partial "toc.html" . }} {{- end }} {{- if .Content }}
  <div class="post-content">
    {{- if not (.Param "disableAnchoredHeadings") }} {{- partial "anchored_headings.html" .Content
    -}} {{- else }}{{ .Content }}{{ end }}
  </div>
  {{- end }}

  <footer class="post-footer">
    {{- $tags := .Language.Params.Taxonomies.tag | default "tags" }} {{- if ($.GetTerms $tags) }}
    <div class="post-tags-section">
      <h3>Tags associés :</h3>
      <ul class="post-tags">
        {{- range ($.GetTerms $tags) }}
        <li><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></li>
        {{- end }}
      </ul>
    </div>
    {{- end }} {{- $auteurs := .Language.Params.Taxonomies.auteur | default "auteurs" }} {{- if
    ($.GetTerms $auteurs) }}
    <div class="post-authors-section">
      <h3>Présentateurs :</h3>
      <ul class="post-authors">
        {{- range ($.GetTerms $auteurs) }}
        <li><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></li>
        {{- end }}
      </ul>
    </div>
    {{- end }} {{- if (.Param "ShowPostNavLinks") }}
    <div class="post-nav-links">
      {{- with .PrevInSection }}
      <a href="{{ .Permalink }}" class="post-nav-prev" title="{{ .Title }}">
        <div>{{ .Title | truncate 60 }}</div>
      </a>
      {{- else }}
      <div></div>
      {{- end }} {{- with .NextInSection }}
      <a href="{{ .Permalink }}" class="post-nav-next" title="{{ .Title }}">
        <div>{{ .Title | truncate 60 }}</div>
      </a>
      {{- else }}
      <div></div>
      {{- end }}
    </div>
    {{- end }} {{- if (and site.Params.ShowShareButtons (ne .Params.disableShare true)) }} {{-
    partial "share_icons.html" . -}} {{- end }}
  </footer>

  {{- if (.Param "comments") }} {{- partial "comments.html" . }} {{- end }}
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Custom tooltip functionality
  const segments = document.querySelectorAll('.spectrum-segment[data-tooltip]');
  let tooltip = null;

  // Create tooltip element
  function createTooltip() {
    if (!tooltip) {
      tooltip = document.createElement('div');
      tooltip.className = 'custom-tooltip';
      document.body.appendChild(tooltip);
    }
    return tooltip;
  }

  // Show tooltip
  function showTooltip(event, text) {
    const tooltip = createTooltip();
    tooltip.textContent = text;
    tooltip.classList.add('show');
    
    const rect = event.target.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    
    // Position tooltip above the segment, very close to it
    tooltip.style.left = Math.max(0, rect.left + (rect.width / 2) - (tooltipRect.width / 2)) + 'px';
    tooltip.style.top = (rect.top - tooltipRect.height + 20 + window.scrollY) + 'px';
  }

  // Hide tooltip
  function hideTooltip() {
    if (tooltip) {
      tooltip.classList.remove('show');
    }
  }

  // Add event listeners to each segment
  segments.forEach(segment => {
    segment.addEventListener('mouseenter', function(e) {
      const tooltipText = this.getAttribute('data-tooltip');
      if (tooltipText) {
        showTooltip(e, tooltipText);
      }
    });

    segment.addEventListener('mouseleave', hideTooltip);
  });

  // Hide tooltip when scrolling
  window.addEventListener('scroll', hideTooltip);
});
</script>

{{- end }}{{/* end main */}}
